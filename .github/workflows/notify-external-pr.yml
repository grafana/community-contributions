name: Notify External PR

on:
  # pull_request_target: # zizmor: ignore[dangerous-triggers]
  #   types: [opened]
  workflow_dispatch: # Manual trigger only for security review

permissions:
  contents: read
  pull-requests: read
  id-token: write

jobs:
  notify:
    runs-on: ubuntu-latest
    if: |
      github.event.pull_request.author_association != 'MEMBER' &&
      github.event.pull_request.author_association != 'OWNER' &&
      github.event.pull_request.author_association != 'COLLABORATOR'

    steps:
      - name: Check if alerting-related
        id: check-scope
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          files=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json files --jq '.files[].path' || echo "")
          
          is_alerting="false"
          if echo "$files" | grep -qE "(pkg/services/ngalert|public/app/features/alerting|apps/alerting)"; then
            is_alerting="true"
          fi
          
          echo "is-alerting=$is_alerting" >> "$GITHUB_OUTPUT"

      - name: Get PR metadata
        if: steps.check-scope.outputs.is-alerting == 'true'
        id: metadata
        env:
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          pr_data=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json additions,deletions,files,title)
          
          additions=$(echo "$pr_data" | jq '.additions')
          deletions=$(echo "$pr_data" | jq '.deletions')
          total=$((additions + deletions))
          
          if [ "$total" -lt 50 ]; then size="small"
          elif [ "$total" -lt 300 ]; then size="medium"
          else size="large"
          fi
          
          title=$(echo "$pr_data" | jq -r '.title // "No title"')
          safe_title=$(echo "$title" | tr -d '\000-\037' | head -c 150)
          
          files=$(echo "$pr_data" | jq -r '.files[].path' | head -5)
          files_display=$(echo "$files" | sed 's/^/‚Ä¢ /' | tr '\n' '|' | sed 's/|$//')
          
          echo "size=$size" >> "$GITHUB_OUTPUT"
          echo "additions=$additions" >> "$GITHUB_OUTPUT"
          echo "deletions=$deletions" >> "$GITHUB_OUTPUT"
          echo "title_b64=$(echo "$safe_title" | base64 -w 0)" >> "$GITHUB_OUTPUT"
          echo "files_b64=$(echo "$files_display" | base64 -w 0)" >> "$GITHUB_OUTPUT"

      - name: Get Vault secrets
        if: steps.check-scope.outputs.is-alerting == 'true'
        uses: grafana/shared-workflows/actions/get-vault-secrets@main
        with:
          repo_secrets: |
            OPENAI_API_KEY=openapi:key
            SLACK_WEBHOOK=slack:webhook

      - name: Mask secrets
        if: steps.check-scope.outputs.is-alerting == 'true'
        run: |
          [ -n "$OPENAI_API_KEY" ] && echo "::add-mask::$OPENAI_API_KEY"
          [ -n "$SLACK_WEBHOOK" ] && echo "::add-mask::$SLACK_WEBHOOK"
        env:
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}

      - name: Classify PR type
        id: classify
        if: steps.check-scope.outputs.is-alerting == 'true'
        env:
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "type=feature" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          
          pr_data=$(gh pr view "$PR_NUMBER" --repo "${{ github.repository }}" --json title,files)
          title=$(echo "$pr_data" | jq -r '.title // ""' | tr -d '\000-\037' | head -c 200)
          files=$(echo "$pr_data" | jq -r '.files[].path' | head -10 | tr '\n' ', ')
          
          SYSTEM_MSG="Classify GitHub PRs. Output ONLY one word: docs, bugfix, or feature. Nothing else."
          USER_MSG="Classify: Title: $title. Files: $files"
          
          PAYLOAD=$(jq -n \
            --arg system "$SYSTEM_MSG" \
            --arg user "$USER_MSG" \
            '{
              model: "gpt-4o-mini",
              messages: [
                {role: "system", content: $system},
                {role: "user", content: $user}
              ],
              max_tokens: 10,
              temperature: 0.1
            }')
          
          response=$(curl -s --max-time 15 https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$PAYLOAD" || echo '{}')
          
          ai_type=$(echo "$response" | jq -r '.choices[0].message.content // ""' | tr -d '[:space:]' | tr '[:upper:]' '[:lower:]')
          
          case "$ai_type" in
            docs|bugfix|feature)
              type="$ai_type"
              ;;
            *)
              type="feature"
              ;;
          esac
          
          echo "type=$type" >> "$GITHUB_OUTPUT"

      - name: Send Slack notification
        if: steps.check-scope.outputs.is-alerting == 'true' && env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ env.SLACK_WEBHOOK }}
          PR_SIZE: ${{ steps.metadata.outputs.size }}
          PR_TYPE: ${{ steps.classify.outputs.type }}
          PR_ADDITIONS: ${{ steps.metadata.outputs.additions }}
          PR_DELETIONS: ${{ steps.metadata.outputs.deletions }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          TITLE_B64: ${{ steps.metadata.outputs.title_b64 }}
          FILES_B64: ${{ steps.metadata.outputs.files_b64 }}
        run: |
          pr_title=$(echo "$TITLE_B64" | base64 -d 2>/dev/null || echo "PR #$PR_NUMBER")
          pr_files=$(echo "$FILES_B64" | base64 -d 2>/dev/null | tr '|' '\n' || echo "")
          
          pr_title=$(echo "$pr_title" | sed 's/@channel//g; s/@here//g; s/@everyone//g')
          
          pr_url="https://github.com/${REPO}/pull/${PR_NUMBER}"
          
          case "$PR_TYPE" in
            "docs") emoji="üìù" ;;
            "bugfix") emoji="üêõ" ;;
            *) emoji="‚ú®" ;;
          esac
          
          case "$PR_SIZE" in
            "small") color="#36a64f" ;;
            "medium") color="#ff9800" ;;
            "large") color="#f44336" ;;
            *) color="#808080" ;;
          esac
          
          PAYLOAD=$(jq -n \
            --arg color "$color" \
            --arg emoji "$emoji" \
            --arg type "$PR_TYPE" \
            --arg size "$PR_SIZE" \
            --arg url "$pr_url" \
            --arg title "$pr_title" \
            --arg files "$pr_files" \
            --arg additions "$PR_ADDITIONS" \
            --arg deletions "$PR_DELETIONS" \
            '{
              attachments: [{
                color: $color,
                blocks: [
                  {
                    type: "header",
                    text: {
                      type: "plain_text",
                      text: "\($emoji) External PR: \($type) (\($size))",
                      emoji: true
                    }
                  },
                  {
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: "*<\($url)|\($title)>*\nby external contributor"
                    }
                  },
                  {
                    type: "section",
                    text: {
                      type: "mrkdwn",
                      text: "*Files:*\n\($files)"
                    }
                  },
                  {
                    type: "context",
                    elements: [{
                      type: "mrkdwn",
                      text: "+\($additions)/-\($deletions) lines | area/alerting"
                    }]
                  }
                ]
              }]
            }')
          
          HTTP_CODE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST -H "Content-Type: application/json" \
            -d "$PAYLOAD" "$SLACK_WEBHOOK")
          
          if [ "$HTTP_CODE" -eq "200" ]; then
            echo "Slack notification sent"
          else
            echo "::warning::Slack failed with HTTP $HTTP_CODE"
          fi
